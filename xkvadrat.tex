Пусть $p$~-- простое нечетное число, $a$~-- целое. Рассмотрим уравнение

\begin{equation}\label{kweq}
x^2=a\pmod p
\end{equation}
Если оно имеет решение, то число $a$ называется квадратичным вычетом, иначе $a$ называется квадратичным невычетом.
Если $x_1$~-- решение уравнения, то $x_2=-x_1$ тоже решение. Более того, если уравнение имеет хотя бы одно решение, то оно имеет ровно два решения.

\subsection*{Упражнения}

\begin{enumerate}
	\item Покажите, что уравнение~\ref{kweq} не может иметь более двух различных решений.
\end{enumerate}


\subsection{Символ Лежандра}

Пусть $p$ простое нечетное число. Функция
\begin{equation}
\left( \frac{a}{p}\right)=\left\{
\begin{array}[c]{ll}
	1, & \mbox{$a$ -- квадратичный вычет по модулю $p$} \\
	0, & \mbox{$p$ делит $a$}  \\
	-1, & \mbox{$a$ -- квадратичный невычет по модулю $p$}\\
	
\end{array}
\right.	
\end{equation}
называется символом Лежандра\index{Лежандра символ}. Обозначение $\left( \frac{a}{p}\right)$ читается: символ $a$ по $p$. Число $a$ называется числителем, а $p$ знаменателем символа.
Символ Лежандра обладает следующими свойствами:

\begin{enumerate}
	\item $a^{\frac{p-1}{2}}=\left( \frac{a}{p}\right)\pmod p$,
	\item если $a=b\pmod p$, то $\left( \frac{a}{p}\right)=\left( \frac{b}{p}\right)$,
	\item $\left( \frac{1}{p}\right)=1$,
	\item $\left( \frac{-1}{p}\right)=(-1)^{\frac{p-1}{2}}$,
	\item $\left( \frac{ab}{p}\right)=\left( \frac{a}{p}\right)\left( \frac{b}{p}\right)$,
	в частности, $\left( \frac{ab^2}{p}\right)=\left( \frac{a}{p}\right)$,
	\item $\left( \frac{2}{p}\right)=(-1)^{\frac{p^2-1}{8}}$,
	\item (закон взаимности квадратичных вычетов) если $p$ и $q$~-- простые нечетные, то 
	$$\left(\frac{q}{p}\right)=(-1)^{\frac{p-1}{2}\cdot\frac{q-1}{2}}\left(\frac{p}{q}\right).$$
\end{enumerate}
Свойство 1 позволяет непосредственно вычислять символ Лежандра.

\subsection*{Упражнения}
Докажите свойства символа Лежандра.


\subsection{Символ Якоби}

Обобщением символа Лежандра является символ Якоби.\index{Якоби символ} Пусть $P$~-- нечетное, большее единицы, и $P=p_1p_2\ldots p_k$~-- разложение его на простые множители, можно и равные. Пусть $a$ и $P$ взаимно простые. Тогда символ Якоби $\left( \frac{a}{P}\right)$ определяется равенством
\[
\left(\frac{a}{P}\right)=\left(\frac{a}{p_1}\right)\left(\frac{a}{p_2}\right)\ldots\left(\frac{a}{p_k}\right).
\] 
Символ Якоби обладает следующими свойствами, аналогичными свойствам символа Лежандра и из них следующими:

\begin{enumerate}
	\item если $a=b\pmod P$, то $\left( \frac{a}{P}\right)=\left( \frac{b}{P}\right)$,
	\item $\left( \frac{1}{P}\right)=1$,
	\item $\left( \frac{-1}{P}\right)=(-1)^{\frac{P-1}{2}}$,
	\item $\left( \frac{ab}{P}\right)=\left( \frac{a}{P}\right)\left( \frac{b}{P}\right)$,
	в частности, $\left( \frac{ab^2}{P}\right)=\left( \frac{a}{P}\right)$,
	\item $\left( \frac{2}{P}\right)=(-1)^{\frac{P^2-1}{8}}$,
	\item  если $P$ и $Q$~-- положительные нечетные взаимно простые, то
	\[
	\left(\frac{Q}{P}\right)=(-1)^{\frac{P-1}{2}\cdot\frac{Q-1}{2}}\left(\frac{P}{Q}\right).
	\]
\end{enumerate}

Свойства символа Якоби позволяют вычислять символ Лежандра быстрее, чем это позволяет свойство 1 символа Лежандра.
\subsection*{Пример}
Выяснить, имеет ли решение уравнение $$x^2=134\pmod{401}.$$
Используя поочередно свойства 4, 5, 6, 1, 4, 5, 6, 1 и 2 вычислим:

\begin{multline*}
\left(\frac{134}{401}\right)=\left(\frac{2}{401}\right)\left(\frac{67}{401}\right)=
\left(-1\right)^{\frac{401^2-1}{8}}\left(\frac{67}{401}\right)=\left(\frac{67}{401}\right)=\\
=\left(-1\right)^{\frac{401-1}{2}\cdot\frac{67-1}{2}}\left(\frac{401}{67}\right)=\left(\frac{66}{67}\right)=
\left(\frac{2}{67}\right)\left(\frac{33}{67}\right)=\\
=-\left(\frac{67}{33}\right)=-\left(\frac{1}{33}\right)=-1.
\end{multline*}
Следовательно, $134$ является квадратичным невычетом по модулю $401$ и уравнение $x^2=134\pmod{401}$ не имеет решений.

\subsection{Квадратичный невычет}

Иногда в алгоритмах требуется знать хотя бы один квадратичный невычет по модулю простого числа $p$. В настоящее время не известен детерминированный полиномиальный алгоритм, вычисляющий для заданного простого числа $p$ квадратичный невычет. Однако найти квадратичный невычет на практике все же легко. Поскольку квадратичных невычетов ровно половина среди всех элементов группы $Z_p^*$, то произвольное случайно выбранное число из $\{2,3,\ldots,p-1\}$ с вероятностью $1/2$ окажется квадратичным невычетом. То есть, чтобы найти $f$, достаточно случайно брать один за другим числа из $\{2,3,\ldots,p-1\}$ и проверять являются ли они невычетами, вычисляя соответствующий символ Лежандра. Как только невычет найден, процесс поиска останавливается. Вероятность за $n$ шагов найти невычет равна $1-1/2^n$, то есть вероятность (экспоненциально) быстро приближается к $1$ с числом шагов.  Такие вероятностные алгоритмы называются алгоритмами типа Лас-Вегас\index{Алгоритм!Лас-Вегас}. Они отличаются от алгоритмов типа Монте-Карло тем, что алгоритмы Монте-Карло\index{Алгоритм!Монте-Карло} за полиномиальное число шагов с вероятностью практически равной $1$ выдают правильный ответ, но всё-таки есть вероятность ошибки (например, принять неправильный ответ за правильный или, наоборот, правильный ответ за неправильный), а алгоритмы типа Лас-Вегас заканчивают работу всегда с правильным ответом и время ожидания этого ответа с вероятностью практически равной $1$ мало, но все же есть пренебрежимо малая, но не равная нулю вероятность того, что алгоритм будет работать неопределенно долго. Другими, более точными, словами, математическое ожидание времени работы алгоритмов Лас-Вегаса полиномиально зависит от размера входных данных.

\subsection{Вычисление квадратных корней по простому модулю: алгоритм Тонелли-Шенкса}
Алгоритм Тонелли-Шенкса позволяет решать уравнения $x^2=a\mod p$, где $p$~-- простое.
Перед тем как начать решать уравнение необходимо убедиться, что $a$ квадратичный вычет. Для этого достаточно вычислить $\left(\frac{a}{p}\right)$.
Пусть $a$ квадратичный вычет. Представим число $p$ в виде $p=2^mq+1$, где $q$~-- нечетное натуральное. Пусть $f$~-- квадратичный невычет по модулю $p$. Пусть $g=f^q\pmod p$.

\paragraph{Упражнение} Докажите, что порядок элемента $g$ равен $2^m$.

Обозначим $b_0=a^q\pmod p$ и пусть $m_0$ минимальное натуральное такое, что $b_0^{2^{m_0}}=1\pmod p$.
Дальше рекуррентно вычисляем последовательность $b_1$, $b_2$, $\ldots$, $b_{k+1}$ до тех пор пока не появится $1$, то есть для некоторого $k$ $b_{k+1}=1$. Элементы последовательности вычисляем по формуле: $b_{i+1}=b_ig^{2^{m-m_i}}\pmod p$, где $m_i$ минимальное натуральное такое, что $b_i^{2^{m_i}}=1\pmod p$.

Из формул следует, что 
$$b_{k+1}=a^{ q}g^{ 2^{m-m_0}+2^{m-m_1}+\ldots+2^{m-m_k}}=1\pmod p.$$
Таким образом
$$a^{q+1}g^{ 2^{m-m_0}+2^{m-m_1}+\ldots+2^{m-m_k}}=a\pmod p$$
и
$$\left(a^{\frac{q+1}{2}}g^{\frac{2^{m-m_0}+2^{m-m_1}+\ldots+2^{m-m_k}}{2}}\right)^2=a\pmod p,$$
то есть решением уравнения $x^2=a\mod p$ является

\begin{equation}\label{eq:tonellishanks}
x=\pm a^{\frac{q+1}{2}}g^{\frac{2^{m-m_0}+2^{m-m_1}+\ldots+2^{m-m_k}}{2}} \pmod p.
\end{equation}

\subsection*{Упражения}

\begin{enumerate}
	\item Запишите вычисление формулы~\ref{eq:tonellishanks} на алгоритмическом языке.
	\item Оптимизируйте алгоритм из упражнения выше по числу умножений.
	\item Докажите корректность алгоритма. 
\end{enumerate}

\subsection{Пример}

Решим уравнение $x^2=8 \pmod{41}$. Проверим, существует ли решение, то есть является ли $8$ квадратичным вычетом по модулю $41$. Вычислим
\[
\left(\frac{8}{41}\right)=\left(\frac{2}{41}\right)\left(\frac{4}{41}\right)=\left(\frac{2}{41}\right)=
(-1)^{\frac{41^2-1}{8}}=(-1)^{\frac{40\cdot 42}{8}}=1.
\]
Вывод: да, решение есть. Определим значения параметров в алгоритме Тонелли-Шенкса: $a=8$, $p=41$, $p=2^mq+1=2^35+1$, $m=3$, $q=5$. Найдем квадратичный невычет $f$. Попробуем $f=3$:
\[
\left(\frac{3}{41}\right)=(-1)^{\frac{(41-1)(3-1)}{2}}\left(\frac{41}{3}\right)=
\left(\frac{41}{3}\right)=\left(\frac{2}{3}\right)=(-1)^{\frac{3^2-1}{8}}=-1.
\]
Да, $f=3$ является квадратичным невычетом по модулю $41$ и $g=f^q\pmod p=3^5\pmod{41}=38$. Вычисляем теперь согласно формулам $b_0$, $b_1$, $b_2$ и т.д. пока $b_i$ не станет равным $1$.
\[
b_0=a^q\pmod p=8^5\pmod{41}=9
\]
Ищем минимальное $m_0$ такое, что $b_0^{2^{m_0}}=1\pmod p$:
\[
9^{2^1}\pmod{41}=40,
\]
\[
9^{2^2}\pmod{41} =40^2 = 1.
\]
Таким образом, $m_0=2$ и
\[
b_{1}=b_0g^{2^{m-m_0}}\pmod p=9\cdot 38^{2^{3-2}}\pmod{41}=40.
\]
Найдем минимальное $m_1$ такое, что $b_1^{2^{m_1}}=1\pmod p$:
\[
40^{2^1}\pmod 41=1.
\]
Таким образом, $m_1=1$ и
\[
b_{2}=b_1g^{2^{m-m_1}}\pmod p=40\cdot 38^{2^{3-1}}\pmod{41}=1.
\]
Вычисления $b_i$ заканчиваем.
Согласно формуле алгоритма Тонелли-Шенкса решение уравнения вычисляем так:
\begin{multline*}
x=\pm a^{\frac{q+1}{2}}g^{\frac{2^{m-m_0}+2^{m-m_1}+\ldots+2^{m-m_k}}{2}} \pmod p=\\
=\pm 8^{3}38^{\frac{2^{1}+2^2}{2}}\pmod{41} =\pm 8^{3}38^3=\pm 20\cdot 14\pmod{41}= \pm 7
\end{multline*}
Ответ:$\pm 7$.